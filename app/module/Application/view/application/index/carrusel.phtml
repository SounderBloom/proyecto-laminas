<?php
/**
 * @var Laminas\View\Renderer\PhpRenderer $this
 */
?>
<style>
.carousel-item > img {
    height: 500px;
    object-fit: cover;
}
</style>

<div class="container" style="height: 100vh; background-color: rgb(240,240,240)">
    <nav aria-label="breadcrumb mt-5">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="<?= $this->url('application', ['action' => 'index']) ?>">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">Carrousel</li>
        </ol>
    </nav>
  <div class="ms-5 ps-5 pe-5 pb-5 pt-2">
    <a href="<?= $this->url('application', ['action' => 'index']) ?>" class="btn btn-dark p-2"><-</a>
    <span class="title mt-5 text-center fs-2 ms-3">Carrusel</span>
  </div>

  <form method="post"
      enctype="multipart/form-data"
      action="<?= $this->url('application', ['action' => 'carrusel']) ?>"
      class="text-center mb-3">

      <label class="btn btn-dark p-4">
          <span id="lbl_agregar_imagen">Agregar Imagen</span>
          <input type="file" name="imagen" accept="image/*" hidden id="input_agregar_imagen">
      </label>

      <button class="btn btn-success ms-3 p-4">Subir</button>
  </form>

  <div class="text-center mb-4">
    <button id="btnEliminarImagenes" class="btn btn-danger">
        Eliminar todas las imágenes
    </button>
  </div>

<?php if (!empty($imagenes)): ?>
<div id="carouselExampleIndicators" class="carousel slide">
    
    <!-- indicadores -->
    <div class="carousel-indicators">
        <?php foreach ($imagenes as $i => $img): ?>
            <button type="button"
                    data-bs-target="#carouselExampleIndicators"
                    data-bs-slide-to="<?= $i ?>"
                    class="<?= $i === 0 ? 'active' : '' ?>">
            </button>
        <?php endforeach; ?>
    </div>

    <!-- slides -->
    <div class="carousel-inner">
        <?php foreach ($imagenes as $i => $img): ?>
            <div class="carousel-item <?= $i === 0 ? 'active' : '' ?>">
                <img src="/uploads/carrusel/<?= $img ?>"
                     class="d-block w-100">
            </div>
        <?php endforeach; ?>
    </div>

    <button class="carousel-control-prev" type="button"
            data-bs-target="#carouselExampleIndicators"
            data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>

    <button class="carousel-control-next" type="button"
            data-bs-target="#carouselExampleIndicators"
            data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</div>
<?php else: ?>
    <p class="text-center">No hay imágenes aún</p>
<?php endif; ?>


<script>
// Referencias
const inputFile    = document.getElementById('input_agregar_imagen');
const labelFile    = document.getElementById('lbl_agregar_imagen');
const btnSubir     = document.querySelector('form button.btn-success'); // el botón Subir

// Iniciar botón Subir deshabilitado
btnSubir.disabled = true;
btnSubir.style.opacity = '0.6';

// Extensiones y MIME permitidos
const allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff', 'svg'];
const validMimeTypes    = [
    'image/jpeg', 'image/png', 'image/gif', 'image/webp',
    'image/bmp', 'image/tiff', 'image/svg+xml'
];

function isValidImage(file) {
    if (!file) return false;

    // Validar extensión
    const ext = file.name.split('.').pop()?.toLowerCase() || '';
    if (allowedExtensions.includes(ext)) {
        return true;
    }

    // Validar MIME type (más confiable)
    return validMimeTypes.includes(file.type);
}

// Evento cuando se selecciona archivo
inputFile.addEventListener('change', () => {
    const file = inputFile.files[0];

    // Resetear estilos y texto por defecto si no hay archivo
    if (!file) {
        labelFile.innerHTML = 'Agregar Imagen';
        labelFile.style.color = '';
        btnSubir.disabled = true;
        btnSubir.style.opacity = '0.6';
        return;
    }

    // Mostrar nombre del archivo inmediatamente
    labelFile.innerHTML = file.name;
    labelFile.style.color = '';

    // Validar si es imagen
    if (isValidImage(file)) {
        // Válido → habilitar botón
        btnSubir.disabled = false;
        btnSubir.style.opacity = '1';
    } else {
        // Inválido → deshabilitar, advertir y limpiar
        btnSubir.disabled = true;
        btnSubir.style.opacity = '0.6';
        labelFile.innerHTML = `Error ${file.name} (no es imagen)`;
        labelFile.style.color = 'red';

        alert('Solo se permiten imágenes (.jpg, .png, .gif, .webp, etc.)');

        // Limpiar selección
        inputFile.value = '';
        setTimeout(() => {
            labelFile.innerHTML = 'Agregar Imagen';
            labelFile.style.color = '';
        }, 2000); // vuelve al texto original después de 2 segundos
    }
});

// El resto del código (botón eliminar) se mantiene igual
document.getElementById('btnEliminarImagenes').addEventListener('click', function () {
    if (!confirm('¿Seguro que deseas eliminar todas las imágenes?')) {
        return;
    }
    fetch('<?= $this->url('application', ['action' => 'eliminarImagenes']) ?>', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.log('Respuesta no OK:', response.status, text);
                throw new Error(`Error ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        alert(data.message);
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ocurrió un error: ' + error.message);
    });
});
</script>